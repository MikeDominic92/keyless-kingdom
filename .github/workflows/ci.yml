name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: read

jobs:
  terraform-validation:
    name: Terraform Validation
    runs-on: ubuntu-latest
    strategy:
      matrix:
        directory:
          - terraform/aws
          - terraform/gcp
          - terraform/azure
          - terraform/modules/oidc_trust
          - examples/s3-deploy
          - examples/gcs-deploy
          - examples/blob-deploy

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Terraform Format Check
        working-directory: ${{ matrix.directory }}
        run: |
          echo "Checking Terraform formatting in ${{ matrix.directory }}"
          terraform fmt -check -recursive || {
            echo "Terraform files are not formatted correctly"
            echo "Run 'terraform fmt -recursive' to fix"
            exit 1
          }

      - name: Terraform Init
        working-directory: ${{ matrix.directory }}
        run: terraform init -backend=false

      - name: Terraform Validate
        working-directory: ${{ matrix.directory }}
        run: terraform validate

  shell-script-validation:
    name: Shell Script Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run ShellCheck
        run: |
          echo "Running ShellCheck on all shell scripts..."
          find . -name "*.sh" -type f | while read -r script; do
            echo "Checking $script"
            shellcheck "$script" || exit 1
          done
          echo "✓ All shell scripts passed validation"

  markdown-linting:
    name: Markdown Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Run markdownlint
        continue-on-error: true
        run: |
          echo "Running markdownlint on all markdown files..."
          markdownlint '**/*.md' --ignore node_modules || {
            echo "⚠ Some markdown files have linting issues"
            echo "This is not blocking, but consider fixing them"
          }

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

      - name: Search for hardcoded secrets
        run: |
          echo "Searching for potential hardcoded secrets..."

          # Check for AWS access keys
          if grep -r "AKIA[0-9A-Z]\{16\}" . --exclude-dir=.git --exclude-dir=node_modules; then
            echo "⚠ WARNING: Found potential AWS access keys!"
            exit 1
          fi

          # Check for private keys
          if grep -r "BEGIN.*PRIVATE KEY" . --exclude-dir=.git --exclude-dir=node_modules; then
            echo "⚠ WARNING: Found potential private keys!"
            exit 1
          fi

          # Check for generic secrets
          if grep -ri "password.*=.*['\"].*['\"]" . --exclude-dir=.git --exclude-dir=node_modules --exclude="*.md"; then
            echo "⚠ WARNING: Found potential hardcoded passwords!"
            exit 1
          fi

          echo "✓ No hardcoded secrets detected"

  documentation-check:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for required documentation
        run: |
          echo "Checking for required documentation files..."

          REQUIRED_FILES=(
            "README.md"
            "LICENSE"
            "CONTRIBUTING.md"
            "CHANGELOG.md"
            "docs/ARCHITECTURE.md"
            "docs/AWS_SETUP.md"
            "docs/GCP_SETUP.md"
            "docs/AZURE_SETUP.md"
            "docs/SECURITY.md"
            "docs/COST_ANALYSIS.md"
          )

          MISSING=0
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "⚠ Missing: $file"
              MISSING=1
            else
              echo "✓ Found: $file"
            fi
          done

          if [ $MISSING -eq 1 ]; then
            echo "Some required documentation files are missing"
            exit 1
          fi

          echo "✓ All required documentation files present"

      - name: Check for broken links in README
        continue-on-error: true
        run: |
          echo "Checking for broken internal links in README..."
          # This is a basic check - in production, use a proper link checker
          if grep -o '\[.*\](.*\.md)' README.md | grep -v "^#"; then
            echo "Found internal markdown links - verify they exist"
          fi

  validate-terraform-examples:
    name: Validate Terraform Examples
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Validate all examples
        run: |
          echo "Validating Terraform examples..."

          for example_dir in examples/*/; do
            if [ -f "${example_dir}main.tf" ]; then
              echo "Validating $example_dir"
              cd "$example_dir"
              terraform init -backend=false
              terraform validate
              cd - > /dev/null
              echo "✓ $example_dir validated successfully"
            fi
          done

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs:
      - terraform-validation
      - shell-script-validation
      - markdown-linting
      - security-scan
      - documentation-check
      - validate-terraform-examples
    if: always()

    steps:
      - name: Check CI status
        run: |
          echo "=================================="
          echo "CI Pipeline Summary"
          echo "=================================="
          echo "Terraform Validation: ${{ needs.terraform-validation.result }}"
          echo "Shell Script Validation: ${{ needs.shell-script-validation.result }}"
          echo "Markdown Linting: ${{ needs.markdown-linting.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          echo "Documentation Check: ${{ needs.documentation-check.result }}"
          echo "Terraform Examples: ${{ needs.validate-terraform-examples.result }}"
          echo ""

          if [ "${{ needs.terraform-validation.result }}" != "success" ] || \
             [ "${{ needs.shell-script-validation.result }}" != "success" ] || \
             [ "${{ needs.security-scan.result }}" != "success" ] || \
             [ "${{ needs.documentation-check.result }}" != "success" ] || \
             [ "${{ needs.validate-terraform-examples.result }}" != "success" ]; then
            echo "❌ CI pipeline failed"
            exit 1
          fi

          echo "✓ All CI checks passed!"
