name: Deploy to AWS

on:
  push:
    branches:
      - main
    paths:
      - 'terraform/aws/**'
      - 'examples/s3-deploy/**'
      - '.github/workflows/deploy-aws.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'terraform/aws/**'
      - 'examples/s3-deploy/**'
  workflow_dispatch:

# Required permissions for OIDC
permissions:
  id-token: write   # Required for requesting JWT
  contents: read    # Required for actions/checkout

env:
  AWS_REGION: us-east-1
  # Replace with your role ARN after deploying terraform/aws
  AWS_ROLE_ARN: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role

jobs:
  validate-terraform:
    name: Validate Terraform
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Terraform Format Check
        working-directory: terraform/aws
        run: terraform fmt -check -recursive

      - name: Terraform Init
        working-directory: terraform/aws
        run: terraform init -backend=false

      - name: Terraform Validate
        working-directory: terraform/aws
        run: terraform validate

  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: validate-terraform
    # Only deploy on push to main, not PRs
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS identity
        run: |
          echo "Verifying AWS credentials..."
          aws sts get-caller-identity
          echo "AWS_REGION: $AWS_REGION"
          echo "Successfully authenticated to AWS using OIDC!"

      - name: List S3 buckets (example)
        run: |
          echo "Listing S3 buckets to verify permissions..."
          aws s3 ls || echo "No S3 buckets found or insufficient permissions"

      - name: Get AWS account information
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "AWS Account ID: $ACCOUNT_ID"
          echo "Role ARN: $(aws sts get-caller-identity --query Arn --output text)"

  test-deployment:
    name: Test S3 Deployment
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-Test-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create test file
        run: |
          echo "Test file created by GitHub Actions using OIDC" > test-file.txt
          echo "Timestamp: $(date)" >> test-file.txt
          echo "Run ID: ${{ github.run_id }}" >> test-file.txt

      - name: Test S3 upload (if bucket exists)
        continue-on-error: true
        run: |
          BUCKET_NAME="keyless-kingdom-deploy-test-$(aws sts get-caller-identity --query Account --output text)"
          echo "Testing upload to bucket: $BUCKET_NAME"

          # Check if bucket exists
          if aws s3 ls "s3://$BUCKET_NAME" 2>/dev/null; then
            aws s3 cp test-file.txt "s3://$BUCKET_NAME/github-actions-test.txt"
            echo "Successfully uploaded test file to S3"
          else
            echo "Test bucket does not exist. Skipping upload test."
            echo "To enable this test, create a bucket named: $BUCKET_NAME"
          fi

      - name: Cleanup
        run: rm -f test-file.txt
